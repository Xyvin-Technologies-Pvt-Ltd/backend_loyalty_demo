name: UAT Loyalty Backend

on:
  push:
    branches:
      - main

jobs:
  deploy-backend:
    name: Deploy Backend to AWS Lightsail Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via SSH using Appleboy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.REMOTE_HOST }}              
          username: ${{ secrets.REMOTE_USER }}          
          key: ${{ secrets.SSH_PRIVATE_KEY }}           
          port: 22

          script: |
            set -e

            cd /home/ubuntu/loyalty-backend 

            # Check for .env file
            ENV_FILE_PATH=/home/ubuntu/loyalty/.env/.env.production
            if [ -f "$ENV_FILE_PATH" ]; then
              echo "‚úÖ .env file found at $ENV_FILE_PATH"
              cp $ENV_FILE_PATH .env
            else
              echo "‚ùå .env file not found at $ENV_FILE_PATH"
              exit 1
            fi

            echo "üìÅ Creating upload directory..."
            mkdir -p /home/ubuntu/loyalty-backend

            echo "üõ†Ô∏è Building Docker image..."
            docker build -t loyalty-backend-img .

            echo "üõë Stopping and removing existing container..."
            docker rm -f loyalty-backend-container || true

            echo "üöÄ Running container..."
            docker run -d \
              --name loyalty-backend-container \
              --network myapp-network \
              --restart always \
              -p 3000:3000 \
              --env-file .env \
              -v /home/loyalty/loyalty-uploads:/app/uploads \
              loyalty-backend-img

            echo "‚úÖ Deployment completed!"
